devtools::document()
devtools::document()
remove.packages("dplyrOracle.Rproj")
remove.packages("dplyrOracle")
devtools::install_local("C:\\Users\\caldasb\\Documents\\Vodafone\\Projects\\dplyrOracle-master")
library(dplyrOracle)
library(dplyr)
library(devtools)
library(dplyr)
install_github("hadley\dplyr")
install_github("hadley/dplyr")
library(httr)
set_config(
use_proxy(url="10.74.51.1", port=80)
)
install_github("hadley/dplyr")
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102",... =)
tbls(db,tables=c("DATA_MON_AUX","SUPP_SERV_AUX","XX_TARIFARIOS","XX_NET_ADD_ON2"))
setwd("~/Vodafone/Projects/dplyrOracle-master/R")
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102",... =)
tbls(db,tables=c("DATA_MON_AUX","SUPP_SERV_AUX","XX_TARIFARIOS","XX_NET_ADD_ON2"))
source()
source("customSqlFunctions.R")
source("dplyrOracle.R")
source("over.R")
source("src-oracle.r")
source("tbl-sql-all.r")
source("tbl-sql.r")
source("translate-sql-base.R")
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102",... =)
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102")
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102")
View(src_oracle)
View(src_oracle)
library(devtools)
load_code()
setwd("~/Vodafone/Projects/dplyrOracle-master")
load_code()
remove.packages("dplyrOracle")
load_code()
load_code(pkg = dplyrOracle)
load_code(pkg = "dplyrOracle")
load_all()
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102")
tbls(db,tables=c("DATA_MON_AUX","SUPP_SERV_AUX","XX_TARIFARIOS","XX_NET_ADD_ON2"))
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
library(readr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(purrr)
library(tidyr)
library(dplyr)
library(plotly)
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
load_all()
build()
roxygen2::roxygenise()
load_all()
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102")
tbls(db,tables=c("DATA_MON_AUX","SUPP_SERV_AUX","XX_TARIFARIOS","XX_NET_ADD_ON2"))
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
dplyr:::unique_name()
sql_subquery.OraConnection <- function(con, from, name = unique_name(), ...) {
if (is.ident(from)) {
setNames(from, name)
} else {
if (is.null(name)) {
build_sql("(", from, ")", con = con)
} else {
build_sql("(", from, ") AS ", ident(name), con = con)
}
}
}
load_all()
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102")
tbls(db,tables=c("DATA_MON_AUX","SUPP_SERV_AUX","XX_TARIFARIOS","XX_NET_ADD_ON2"))
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC')
data$query
data$info
data["MSISDN"]
load_all()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC')
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
data$query
full_data$query
explain(full_data)
explain(data)
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
load_all()
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102")
tbls(db,tables=c("DATA_MON_AUX","SUPP_SERV_AUX","XX_TARIFARIOS","XX_NET_ADD_ON2"))
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G')) %>%
collect()
explain(data)
unique_name()
load_all()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G')) %>%
collect()
load_all()
roxygen2::roxygenise()
load_all()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G')) %>%
collect()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB,
SERV_ST_CODE
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", PHONE_TECHNOLOGY %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB,
SERV_ST_CODE
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", tech %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB,
SERV_ST_CODE,
BUSINESS_LN_DESC
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", tech %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect()
?collect
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB,
SERV_ST_CODE,
BUSINESS_LN_DESC
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", tech %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect(n=Inf)
library(multidplyr)
library(dplyrOracle)
library(scales)
db <- src_oracle(dbname = "//ora-grid10-scan.pt.sedc.internal.vodafone.com/CSTMRDM",port = 1521, user = "CALDASB", password = "pt213#102")
tbls(db,tables=c("DATA_MON_AUX","SUPP_SERV_AUX","XX_TARIFARIOS","XX_NET_ADD_ON2"))
serv_sup <- supp_serv_aux %>% left_join(xx_net_add_on2,by="SUPP_SERV_CODE") %>% filter(!is.na(QTD_MB_ADD_ON),(SUPP_SERV_ST_CODE== 'AC' || is.na(SUPP_SERV_ST_CODE))) %>%
group_by(DW_ORIG_SERV_ID) %>% summarise(mb_addons = sum(QTD_MB_ADD_ON))
full_data <- data_mon_aux %>% left_join(serv_sup, by="DW_ORIG_SERV_ID") %>% left_join(xx_tarifarios, by="DW_PRICING_PLAN_ID")
data <- select(full_data,
DW_ORIG_SERV_ID,
MSISDN,
#               PRICING_PLAN_CODE.x,
#               CUST_CLASS_TYPE,
tech = PHONE_TECHNOLOGY,
tech_cat = PHONE_TECHNOLOGY_CATEGORY,
SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,
#               SERV_W_V_UNITS_KB_1:SERV_W_V_UNITS_KB_12,
SERV_ARPU_DATA_1:SERV_ARPU_DATA_12,
mb_addons,QTD_DADOS_IN_BUNDLE_MB,
SERV_ST_CODE,
BUSINESS_LN_DESC
) %>%
filter(MSISDN != "910592733",BUSINESS_LN_DESC == "GSM Post-Paid", tech %in% c('Other Smartphones-Forced-4G','iPhones - iOS - 3G','iPhones - iOS - 2G','Other Smartphones-Android-3G','Other Smartphones-Others-3G','Other Smartphones-Symbian-3G','Other Smartphones-Android-4G','Other Smartphones-Others-4G','Other Smartphones-Forced-2G','iPhones - iOS - 4G','Other Smartphones-Others-2G','Other Smartphones-Forced-3G'), SERV_ST_CODE=='AC') %>%
collect(n=Inf)
data_allowance <- data %>% mutate(mb_addons = ifelse(is.na(mb_addons),0,mb_addons), mb_tarifario = ifelse(is.na(QTD_DADOS_IN_BUNDLE_MB),0,QTD_DADOS_IN_BUNDLE_MB), allowance = mb_addons + mb_tarifario)
#average_mb = rowMeans(select(.,contains("SERV_DATA_VOLUM_KB")))/1024
#percentagem=100*average_mb/allowance
#rm(data)
gathered_data <- data_allowance %>%
gather("var_month","value",SERV_DATA_VOLUM_KB_1:SERV_DATA_VOLUM_KB_12,SERV_ARPU_DATA_1:SERV_ARPU_DATA_12 ) %>%
extract(var_month, c("var","month"),regex = "(.*)_(\\d{1,2})" ) %>%
spread(var,value) %>%
mutate(month = as.numeric(month),overage =SERV_DATA_VOLUM_KB/1024 - allowance, percentagem=100*SERV_DATA_VOLUM_KB/1024/allowance, estimated_mb_overage = 200*(SERV_ARPU_DATA-(2.4*mb_addons/200))/2.4, estimated_percentagem=1+estimated_mb_overage/allowance)
rm(data_allowance)
data_by_msisdn <- gathered_data %>%
partition() %>%
mutate(grupo_mes = ifelse(month<=3,1,2)) %>%
group_by(MSISDN,grupo_mes) %>%
summarise(allowance = mean(allowance),mb_addon=first(mb_addons),mean_mb = mean(SERV_DATA_VOLUM_KB/1024),mean_percentagem = mean(percentagem),mean_estimated_mb_overage = mean(estimated_mb_overage), mean_estimated_percentagem = mean(estimated_percentagem), mean_arpu=mean(SERV_ARPU_DATA), mean_overage= ifelse(mean(overage)<0,0,mean(overage))) %>%
#  mutate(allowance = escalao_overage_mb(allowance),mb_addon = escalao_overage_mb(mb_addon),percentagem = escalao_percentagem(mean_percentagem),mb_overage = escalao_overage_mb(mean_overage),estimated_mb_overage =escalao_overage_mb(mean_estimated_mb_overage),  arpu=escalao_arpu(mean_arpu))
mutate(percentagem = escalao_percentagem(mean_percentagem)) %>%
collect()
evolucao_msisdn <- data_by_msisdn %>% select(MSISDN,grupo_mes,allowance,percentagem) %>% spread(grupo_mes,mean_per)
filtered_data <- data_by_msisdn %>% filter(is.finite(mean_percentagem)) %>% filter(!scores(mean_percentagem,prob=0.9))
